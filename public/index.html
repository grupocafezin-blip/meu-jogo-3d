<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Clique na Cor Certa — Multiplayer Example</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#0a0a0a;color:#eee;font-family:Arial;text-align:center}
    #menu{padding:12px}
    input,button,select{padding:8px;margin:6px;font-size:16px}
    #gameFrame{width:100%;height:calc(100vh - 120px);border-top:1px solid #222;background:#050505;display:flex;align-items:center;justify-content:center}
    #gameFrame iframe{width:800px;height:600px;border:0;box-shadow:0 8px 40px #000}
    #roomInfo{margin-top:8px}
  </style>
</head>
<body>
  <div id="menu">
    <input id="name" placeholder="Seu nome" />
    <input id="roomId" placeholder="ID da sala (opcional)" />
    <button id="btnCreate">Criar Sala</button>
    <button id="btnJoin">Entrar na Sala</button>
    <select id="multiplierPreset">
      <option value="default">Multiplier: padrão</option>
      <option value="hard">Multiplier rápido</option>
    </select>
    <div id="roomInfo"></div>
  </div>

  <div id="gameFrame">
    <!-- We'll load the game HTML (single-player file) inside an iframe and communicate via postMessage.
         For simplicity the game file is public/game.html which we also include in this package.
         The iframe approach allows keeping the original game code mostly unchanged and just add network glue. -->
    <iframe id="gameIframe" src="game.html"></iframe>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const nameInput = document.getElementById('name');
    const roomIdInput = document.getElementById('roomId');
    const btnCreate = document.getElementById('btnCreate');
    const btnJoin = document.getElementById('btnJoin');
    const roomInfo = document.getElementById('roomInfo');
    const iframe = document.getElementById('gameIframe');
    let currentRoom = null;

    // Send messages to iframe (game) to control multiplayer behavior
    function postToGame(obj){
      iframe.contentWindow.postMessage(obj, '*');
    }

    btnCreate.addEventListener('click', async ()=>{
      const name = nameInput.value || 'Player';
      const res = await new Promise(resolve => socket.emit('createRoom', {roomId: roomIdInput.value || null, name}, resolve));
      if(res.ok){
        currentRoom = res.roomId;
        roomInfo.innerText = 'Sala criada: ' + currentRoom;
        postToGame({ type: 'multiplayer-ready', roomId: currentRoom, name });
      } else {
        alert('Erro criando sala: ' + res.error);
      }
    });

    btnJoin.addEventListener('click', async ()=>{
      const name = nameInput.value || 'Player';
      const id = roomIdInput.value;
      if(!id){ alert('Informe o ID da sala para entrar'); return; }
      const res = await new Promise(resolve => socket.emit('joinRoom', {roomId: id, name}, resolve));
      if(res.ok){
        currentRoom = res.roomId;
        roomInfo.innerText = 'Entrou na sala: ' + currentRoom;
        postToGame({ type: 'multiplayer-ready', roomId: currentRoom, name });
      } else {
        alert('Erro entrando na sala: ' + res.error);
      }
    });

    // Forward game events to server
    window.addEventListener('message', (ev)=>{
      const data = ev.data;
      if(!data || !data.type) return;
      if(data.type === 'scoreHit'){
        // forward to server
        socket.emit('scoreHit', { correct: data.correct }, (ack)=> {
          // send updated room info to game
          postToGame({ type: 'roomUpdate', room: ack });
        });
      } else if(data.type === 'updateState'){
        // forward player state (position, etc) to other players
        socket.emit('updateState', data.state);
      } else if(data.type === 'advanceLevel'){
        socket.emit('advanceLevel');
      }
    }, false);

    // Receive updates from server and forward to game iframe
    socket.on('roomUpdate', (room)=>{
      postToGame({ type: 'roomUpdate', room });
    });

    // Also forward other players' state
    socket.on('playerState', (payload)=>{
      postToGame({ type: 'playerState', player: payload });
    });

  </script>
</body>
</html>