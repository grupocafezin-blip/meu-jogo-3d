<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lobby Cooperativo — Clique na Cor</title>
  <style>
    :root{--bg:#0e0e10;--panel:#151518;--muted:#a1a1aa;--text:#f4f4f5;--acc:#22c55e}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px;box-shadow:0 8px 30px #00000066}
    input,select,button{font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f10;color:var(--text);outline:none}
    button{cursor:pointer}
    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .muted{color:var(--muted);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a2a2a;border-radius:999px;background:#0f0f10}
    .ready{color:#16a34a}
    .notready{color:#f97316}
    #gameFrame{display:none;margin-top:14px}
    #gameIframe{width:100%;height:70vh;border:1px solid #222;border-radius:14px}
    #players{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:8px}
    #lives{font-weight:700}
    .startHint{font-size:14px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lobby Cooperativo</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Sala (room):</label>
          <input id="roomId" placeholder="ex: abc123" />
        </div>
        <div>
          <label>Seu nome:</label>
          <input id="playerName" placeholder="Jogador" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Cor do jogador:</label>
          <input id="playerColor" type="color" value="#42b7ff"/>
        </div>
        <div>
          <label>Vidas por jogador:</label>
          <input id="perLives" type="number" min="1" max="10" value="3" />
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="btnJoin">Entrar na sala</button>
        <button id="btnReady" disabled>Ficar PRONTO</button>
        <span id="sharedInfo" class="pill muted">Vidas compartilhadas: <span id="lives">-</span></span>
        <span id="levelInfo" class="pill muted">Nível: <span id="level">1</span></span>
      </div>
      <div class="startHint muted" id="hint">Precisa de pelo menos 2 jogadores, e todos devem ficar PRONTOS.</div>
      <div id="players"></div>
    </div>

    <div id="gameFrame" class="card">
      <iframe id="gameIframe" src="game.html"></iframe>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Helpers
    function qs(id){ return document.getElementById(id); }
    function getParam(name){ try{ const u=new URL(location.href); return u.searchParams.get(name) }catch(e){ return null }}

    const socket = io();
    const roomIdEl = qs('roomId');
    const nameEl = qs('playerName');
    const colorEl = qs('playerColor');
    const perLivesEl = qs('perLives');
    const btnJoin = qs('btnJoin');
    const btnReady = qs('btnReady');
    const playersEl = qs('players');
    const hintEl = qs('hint');
    const livesEl = qs('lives');
    const levelEl = qs('level');
    const gameFrame = qs('gameFrame');
    const iframe = qs('gameIframe').contentWindow;

    // Prefill from URL
    const rid = getParam('room') || '';
    if(rid) roomIdEl.value = rid;

    btnJoin.onclick = () => {
      const roomId = roomIdEl.value.trim() || 'public';
      const name = nameEl.value.trim() || 'Jogador';
      const color = colorEl.value || '#ffffff';
      const perLives = parseInt(perLivesEl.value, 10) || 3;
      socket.emit('joinRoom', { roomId, name, color, perPlayerLives: perLives });
      btnReady.disabled = false;
      hintEl.textContent = 'Clique em PRONTO e aguarde os outros jogadores.';
      history.replaceState({}, '', `?room=${encodeURIComponent(roomId)}`);
    };

    let ready = false;
    btnReady.onclick = () => {
      ready = !ready;
      socket.emit('setReady', ready);
      btnReady.textContent = ready ? 'Cancelar PRONTO' : 'Ficar PRONTO';
    };

    socket.on('roomUpdate', (room) => {
      // Render players
      playersEl.innerHTML = '';
      const ids = Object.keys(room.players);
      ids.forEach(id => {
        const p = room.players[id];
        const div = document.createElement('div');
        div.className = 'pill';
        div.innerHTML = `
          <span style="display:inline-block;width:12px;height:12px;border-radius:999px;background:${p.color}"></span>
          <strong>${p.name || id.slice(0,5)}</strong>
          <span class="${p.ready?'ready':'notready'}">• ${p.ready ? 'PRONTO' : 'aguardando'}</span>
        `;
        playersEl.appendChild(div);
      });
      if(room.sharedLives !== undefined) livesEl.textContent = room.sharedLives;
      if(room.level !== undefined) levelEl.textContent = room.level;
      if(room.started){
        hintEl.textContent = 'Partida iniciada!';
        gameFrame.style.display = 'block';
      } else {
        gameFrame.style.display = 'none';
      }
    });

    socket.on('startGame', (cfg) => {
      livesEl.textContent = cfg.sharedLives;
      levelEl.textContent = cfg.level || 1;
      gameFrame.style.display = 'block';
      // Inform the iframe that game started (if it cares)
      iframe.postMessage({ type:'startGame', cfg }, '*');
    });

    socket.on('sharedLivesUpdate', ({ sharedLives }) => {
      livesEl.textContent = sharedLives;
      iframe.postMessage({ type:'sharedLivesUpdate', sharedLives }, '*');
    });

    socket.on('playerState', (data) => {
      // Forward to game iframe (so it can render remote players)
      iframe.postMessage({ type:'playerState', player: data }, '*');
    });

    socket.on('levelUpdate', ({ level }) => {
      levelEl.textContent = level;
      iframe.postMessage({ type:'levelUpdate', level }, '*');
    });

    socket.on('gameOverAll', () => {
      iframe.postMessage({ type:'gameOverAll' }, '*');
      hintEl.textContent = 'Acabaram as vidas da equipe. Fiquem prontos novamente para recomeçar.';
      ready = false;
      btnReady.textContent = 'Ficar PRONTO';
    });

    // Listen to messages from the game iframe and forward to server
    window.addEventListener('message', (ev) => {
      const msg = ev.data || {};
      if(msg.type === 'scoreHit'){
        socket.emit('scoreHit', { correct: !!msg.correct });
      } else if(msg.type === 'updateState'){
        socket.emit('stateUpdate', msg.state || {});
      } else if(msg.type === 'advanceLevel'){
        socket.emit('advanceLevel');
      }
    }, false);
  </script>
</body>
</html>
